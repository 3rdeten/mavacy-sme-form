<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Matter Expert Knowledge Transfer | Mavacy</title>
  <style>
    :root {
      --mavacy-navy: #1a2332;
      --mavacy-blue: #2c5282;
      --mavacy-accent: #4299e1;
      --mavacy-gold: #d69e2e;
      --mavacy-light: #f7fafc;
      --mavacy-gray: #718096;
      --mavacy-dark-gray: #4a5568;
      --mavacy-border: #e2e8f0;
      --mavacy-success: #48bb78;
      --mavacy-white: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
      --radius: 8px;
      --radius-lg: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--mavacy-light);
      color: var(--mavacy-navy);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--mavacy-navy) 0%, var(--mavacy-blue) 100%);
      color: var(--mavacy-white);
      padding: 2.5rem 1.5rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(66,153,225,0.15) 0%, transparent 70%);
      border-radius: 50%;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      position: relative;
    }

    .header p {
      font-size: 1rem;
      opacity: 0.85;
      max-width: 640px;
      margin: 0 auto;
      position: relative;
    }

    .header .badge {
      display: inline-block;
      background: rgba(214,158,46,0.2);
      border: 1px solid var(--mavacy-gold);
      color: var(--mavacy-gold);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      margin-bottom: 1rem;
    }

    /* Layout */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* Progress bar */
    .progress-bar {
      background: var(--mavacy-white);
      border-radius: var(--radius-lg);
      padding: 1.25rem 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--mavacy-border);
    }

    .progress-bar .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--mavacy-gray);
      margin-bottom: 0.5rem;
    }

    .progress-bar .track {
      background: var(--mavacy-border);
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar .fill {
      background: linear-gradient(90deg, var(--mavacy-accent), var(--mavacy-blue));
      height: 100%;
      border-radius: 3px;
      transition: width 0.4s ease;
      width: 0%;
    }

    /* Sections */
    .section {
      background: var(--mavacy-white);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--mavacy-border);
      transition: box-shadow 0.2s ease;
    }

    .section:hover {
      box-shadow: var(--shadow-md);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .section-number {
      background: var(--mavacy-blue);
      color: var(--mavacy-white);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .section h2 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--mavacy-navy);
    }

    .section-description {
      color: var(--mavacy-gray);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      padding-left: 2.75rem;
    }

    /* Form elements */
    .field {
      margin-bottom: 1.5rem;
    }

    .field:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--mavacy-navy);
      margin-bottom: 0.4rem;
    }

    label .hint {
      font-weight: 400;
      color: var(--mavacy-gray);
      font-size: 0.825rem;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1.5px solid var(--mavacy-border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-family: inherit;
      color: var(--mavacy-navy);
      background: var(--mavacy-white);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--mavacy-accent);
      box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    textarea.large {
      min-height: 180px;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    .required::after {
      content: ' *';
      color: #e53e3e;
    }

    /* Buttons */
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.8rem 1.75rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--mavacy-blue), var(--mavacy-accent));
      color: var(--mavacy-white);
      box-shadow: 0 2px 8px rgba(44,82,130,0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 4px 16px rgba(44,82,130,0.4);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--mavacy-white);
      color: var(--mavacy-blue);
      border: 1.5px solid var(--mavacy-blue);
    }

    .btn-secondary:hover {
      background: rgba(44,82,130,0.05);
    }

    .btn-success {
      background: var(--mavacy-success);
      color: var(--mavacy-white);
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Preview panel */
    .preview-panel {
      display: none;
      background: var(--mavacy-white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--mavacy-border);
      overflow: hidden;
      margin-top: 2rem;
    }

    .preview-panel.visible {
      display: block;
    }

    .preview-header {
      background: var(--mavacy-navy);
      color: var(--mavacy-white);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-header h3 {
      font-size: 1rem;
      font-weight: 600;
    }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
    }

    .preview-actions .btn {
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
    }

    .preview-content {
      padding: 1.5rem;
      max-height: 600px;
      overflow-y: auto;
    }

    .preview-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.85rem;
      line-height: 1.7;
      color: var(--mavacy-dark-gray);
      background: #f8fafc;
      padding: 1.25rem;
      border-radius: var(--radius);
      border: 1px solid var(--mavacy-border);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--mavacy-navy);
      color: var(--mavacy-white);
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Intro card */
    .intro-card {
      background: linear-gradient(135deg, #ebf8ff 0%, #f0fff4 100%);
      border: 1px solid #bee3f8;
      border-radius: var(--radius-lg);
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
    }

    .intro-card h3 {
      font-size: 1rem;
      color: var(--mavacy-blue);
      margin-bottom: 0.5rem;
    }

    .intro-card p {
      font-size: 0.9rem;
      color: var(--mavacy-dark-gray);
    }

    .intro-card ul {
      margin-top: 0.5rem;
      padding-left: 1.25rem;
      font-size: 0.9rem;
      color: var(--mavacy-dark-gray);
    }

    .intro-card li {
      margin-bottom: 0.25rem;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .header h1 { font-size: 1.35rem; }
      .container { padding: 1.25rem 1rem 3rem; }
      .section { padding: 1.5rem; }
      .actions { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }

    /* Print styles */
    @media print {
      .header, .progress-bar, .actions, .preview-actions, .toast { display: none; }
      .preview-panel { box-shadow: none; border: none; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="badge">Mavacy Knowledge System</div>
    <h1>Subject Matter Expert Knowledge Transfer</h1>
    <p>Help us capture your expertise. Your answers will be transformed into structured knowledge that powers Mavacy's AI-assisted legal drafting system.</p>
  </div>

  <div class="container">

    <div class="progress-bar">
      <div class="label">
        <span>Progress</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="track">
        <div class="fill" id="progressFill"></div>
      </div>
    </div>

    <div class="intro-card">
      <h3>How this works</h3>
      <p>Answer the questions below based on your area of expertise. There are no wrong answers &mdash; we're capturing how <em>you</em> think about this area of law. When you're done:</p>
      <ul>
        <li>Click <strong>Generate Markdown</strong> to see the formatted output</li>
        <li>Review it, then <strong>Download</strong> or <strong>Copy</strong> to share with the team</li>
        <li>The team will review and integrate your knowledge into the system</li>
      </ul>
    </div>

    <form id="smeForm" autocomplete="off">

      <!-- Section 1: Expert Info -->
      <div class="section" data-section="1">
        <div class="section-header">
          <div class="section-number">1</div>
          <h2>About You</h2>
        </div>
        <p class="section-description">Tell us who you are and what you're an expert in.</p>

        <div class="field">
          <label for="expertName" class="required">Your Name</label>
          <input type="text" id="expertName" placeholder="e.g. Jane Smith" required>
        </div>

        <div class="field">
          <label for="expertTitle">Title / Role <span class="hint">(optional)</span></label>
          <input type="text" id="expertTitle" placeholder="e.g. Senior Corporate Attorney, Tax Consultant">
        </div>

        <div class="field">
          <label for="expertEmail">Email <span class="hint">(optional &mdash; for follow-up questions)</span></label>
          <input type="email" id="expertEmail" placeholder="jane@example.com">
        </div>

        <div class="field">
          <label for="knowledgeLayer" class="required">What layer of knowledge are you contributing to?</label>
          <select id="knowledgeLayer" required>
            <option value="">Select one...</option>
            <option value="matter">Matter (e.g. Corporate, Litigation, IP)</option>
            <option value="subtype">Subtype (e.g. Entity Formation, Trademark, ADR)</option>
            <option value="subject_matter">Subject Matter / Industry (e.g. Healthcare, Film Tax Credits)</option>
            <option value="general">General / Cross-cutting expertise</option>
          </select>
        </div>

        <div class="field">
          <label for="expertiseArea" class="required">Specific Area of Expertise</label>
          <input type="text" id="expertiseArea" placeholder="e.g. Corporate, Entity Formation, Healthcare compliance, IRS 181 tax credits" required>
        </div>

        <div class="field">
          <label for="experienceYears">Years of Experience in This Area <span class="hint">(optional)</span></label>
          <input type="text" id="experienceYears" placeholder="e.g. 15 years">
        </div>
      </div>

      <!-- Section 2: Scope & Application -->
      <div class="section" data-section="2">
        <div class="section-header">
          <div class="section-number">2</div>
          <h2>Scope &amp; Application</h2>
        </div>
        <p class="section-description">Help us understand when and how this expertise applies.</p>

        <div class="field">
          <label for="scope" class="required">What types of legal work does your expertise cover?</label>
          <textarea id="scope" placeholder="Describe the scope of work this expertise applies to. What types of matters, transactions, disputes, or client needs fall within this area?" required></textarea>
        </div>

        <div class="field">
          <label for="triggers" class="required">When should this knowledge be used?</label>
          <textarea id="triggers" placeholder="What triggers or signals indicate that this expertise is needed? What keywords, fact patterns, or client requests should activate this knowledge?" required></textarea>
        </div>
      </div>

      <!-- Section 3: Core Knowledge -->
      <div class="section" data-section="3">
        <div class="section-header">
          <div class="section-number">3</div>
          <h2>Core Knowledge</h2>
        </div>
        <p class="section-description">The most important things an attorney or AI system should know.</p>

        <div class="field">
          <label for="principles" class="required">What are the most important principles, rules, or considerations in this area?</label>
          <textarea id="principles" class="large" placeholder="List the key principles, governing rules, or critical considerations. Think: what would you tell a new attorney on their first day working in this area?" required></textarea>
        </div>

        <div class="field">
          <label for="methodology" class="required">What is the standard approach or methodology for this type of work?</label>
          <textarea id="methodology" class="large" placeholder="Walk through how you approach this work from start to finish. What's the typical process, sequence of steps, or analytical framework?" required></textarea>
        </div>

        <div class="field">
          <label for="keyTerms">Key terms, definitions, or concepts <span class="hint">(optional)</span></label>
          <textarea id="keyTerms" placeholder="Are there specific terms, legal definitions, or concepts that are essential to this area? List them with brief explanations."></textarea>
        </div>
      </div>

      <!-- Section 4: Checklists & Procedures -->
      <div class="section" data-section="4">
        <div class="section-header">
          <div class="section-number">4</div>
          <h2>Checklists &amp; Procedures</h2>
        </div>
        <p class="section-description">What should always be done, checked, or included.</p>

        <div class="field">
          <label for="checklist" class="required">What should always be checked, verified, or included in work product for this area?</label>
          <textarea id="checklist" class="large" placeholder="List the items that should be on every checklist. Think: what would you be embarrassed to miss? What does due diligence look like here?" required></textarea>
        </div>

        <div class="field">
          <label for="procedures">Standard procedures or required filings <span class="hint">(optional)</span></label>
          <textarea id="procedures" placeholder="Are there standard procedures, government filings, registration requirements, or formal steps that must be completed?"></textarea>
        </div>

        <div class="field">
          <label for="templates">Standard documents, templates, or forms <span class="hint">(optional)</span></label>
          <textarea id="templates" placeholder="Are there standard documents, template agreements, court forms, or boilerplate language commonly used in this area?"></textarea>
        </div>
      </div>

      <!-- Section 5: Pitfalls, Risks & Jurisdictional Issues -->
      <div class="section" data-section="5">
        <div class="section-header">
          <div class="section-number">5</div>
          <h2>Pitfalls, Risks &amp; Jurisdictional Issues</h2>
        </div>
        <p class="section-description">What goes wrong and what to watch for.</p>

        <div class="field">
          <label for="mistakes" class="required">What are the most common mistakes or oversights in this area?</label>
          <textarea id="mistakes" class="large" placeholder="What do less experienced attorneys typically get wrong? What mistakes have you seen cause real problems? What's easy to overlook?" required></textarea>
        </div>

        <div class="field">
          <label for="redFlags" class="required">What are the biggest risk areas or red flags to watch for?</label>
          <textarea id="redFlags" placeholder="What fact patterns, contract terms, or situations should immediately trigger heightened scrutiny or concern?" required></textarea>
        </div>

        <div class="field">
          <label for="jurisdictional">Jurisdictional considerations <span class="hint">(optional)</span></label>
          <textarea id="jurisdictional" placeholder="Are there jurisdiction-specific rules, variations, or requirements? Any states or jurisdictions with notably different approaches?"></textarea>
        </div>
      </div>

      <!-- Section 6: Quality & Client Communication -->
      <div class="section" data-section="6">
        <div class="section-header">
          <div class="section-number">6</div>
          <h2>Quality &amp; Client Communication</h2>
        </div>
        <p class="section-description">What separates great work from adequate work.</p>

        <div class="field">
          <label for="quality">What separates excellent work from adequate work in this area?</label>
          <textarea id="quality" placeholder="What's the difference between a competent job and an outstanding one? What do the best practitioners do that others don't?"></textarea>
        </div>

        <div class="field">
          <label for="clientComm">What do clients most need to understand about this area?</label>
          <textarea id="clientComm" placeholder="What are the most important things to communicate to clients? What misconceptions do clients commonly have? What should a client-facing email always address?"></textarea>
        </div>
      </div>

      <!-- Section 7: References & Resources -->
      <div class="section" data-section="7">
        <div class="section-header">
          <div class="section-number">7</div>
          <h2>References &amp; Resources</h2>
        </div>
        <p class="section-description">Key authorities, statutes, and resources.</p>

        <div class="field">
          <label for="statutes">Key statutes, regulations, or cases <span class="hint">(optional)</span></label>
          <textarea id="statutes" placeholder="List the most important statutes, regulations, case law, or regulatory guidance that governs this area."></textarea>
        </div>

        <div class="field">
          <label for="resources">Other resources or references <span class="hint">(optional)</span></label>
          <textarea id="resources" placeholder="Any treatises, practice guides, industry standards, or other resources that are essential references?"></textarea>
        </div>
      </div>

      <!-- Section 8: Additional Knowledge -->
      <div class="section" data-section="8">
        <div class="section-header">
          <div class="section-number">8</div>
          <h2>Anything Else</h2>
        </div>
        <p class="section-description">Catch-all for knowledge that didn't fit above.</p>

        <div class="field">
          <label for="additional">Is there anything else important that an AI-assisted legal drafting system should know about this area?</label>
          <textarea id="additional" class="large" placeholder="Anything we didn't ask about? War stories, edge cases, things only someone with deep experience would know? This is your chance to share anything that would make the system smarter."></textarea>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button type="button" class="btn btn-primary" id="generateBtn" onclick="generateMarkdown()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
          Generate Markdown
        </button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">
          Clear Form
        </button>
      </div>
    </form>

    <!-- Preview Panel -->
    <div class="preview-panel" id="previewPanel">
      <div class="preview-header">
        <h3>Generated Markdown</h3>
        <div class="preview-actions">
          <button class="btn btn-success" onclick="downloadMarkdown()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download .md
          </button>
          <button class="btn btn-secondary" onclick="copyMarkdown()" style="background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.3);">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            Copy
          </button>
        </div>
      </div>
      <div class="preview-content">
        <pre id="markdownOutput"></pre>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ─── Progress tracking ───────────────────────────────────
    const requiredFields = document.querySelectorAll('[required]');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');

    function updateProgress() {
      let filled = 0;
      requiredFields.forEach(f => {
        if (f.value.trim()) filled++;
      });
      const pct = Math.round((filled / requiredFields.length) * 100);
      progressFill.style.width = pct + '%';
      progressPercent.textContent = pct + '%';
    }

    requiredFields.forEach(f => {
      f.addEventListener('input', updateProgress);
      f.addEventListener('change', updateProgress);
    });

    // ─── Toast notifications ─────────────────────────────────
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ─── Validation ──────────────────────────────────────────
    function validateForm() {
      let valid = true;
      requiredFields.forEach(f => {
        if (!f.value.trim()) {
          f.style.borderColor = '#e53e3e';
          valid = false;
        } else {
          f.style.borderColor = '';
        }
      });
      if (!valid) {
        showToast('Please fill in all required fields.');
        // Scroll to first invalid field
        const first = document.querySelector('[required]:invalid, [required][style*="border-color: rgb(229, 62, 62)"]');
        if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return valid;
    }

    // ─── Helper: format text block ──────────────────────────
    function formatBlock(text) {
      if (!text || !text.trim()) return '';
      return text.trim();
    }

    // ─── Helper: build list from text ───────────────────────
    function textToList(text) {
      if (!text || !text.trim()) return '';
      const lines = text.trim().split('\n').filter(l => l.trim());
      return lines.map(l => {
        const cleaned = l.replace(/^[-•*]\s*/, '').trim();
        return '- ' + cleaned;
      }).join('\n');
    }

    // ─── Generate Markdown ──────────────────────────────────
    function generateMarkdown() {
      if (!validateForm()) return;

      const v = (id) => document.getElementById(id).value.trim();
      const layerMap = {
        'matter': 'Matter',
        'subtype': 'Subtype',
        'subject_matter': 'Subject Matter / Industry',
        'general': 'General / Cross-cutting'
      };

      const area = v('expertiseArea');
      const layer = layerMap[v('knowledgeLayer')] || v('knowledgeLayer');
      const now = new Date().toISOString().split('T')[0];

      let md = '';

      // Title
      md += `# ${area} — ${layer} Knowledge\n\n`;

      // Metadata
      md += `> **Contributed by:** ${v('expertName')}`;
      if (v('expertTitle')) md += ` (${v('expertTitle')})`;
      md += `\n`;
      if (v('experienceYears')) md += `> **Experience:** ${v('experienceYears')}\n`;
      md += `> **Date:** ${now}\n`;
      if (v('expertEmail')) md += `> **Contact:** ${v('expertEmail')}\n`;
      md += `> **Knowledge layer:** ${layer}\n`;
      md += '\n---\n\n';

      // Scope
      md += `## Scope\n\n`;
      md += `${formatBlock(v('scope'))}\n\n`;

      // When to use
      md += `## When to Use This Knowledge\n\n`;
      md += `${formatBlock(v('triggers'))}\n\n`;

      // Core principles
      md += `## Key Principles & Considerations\n\n`;
      md += `${formatBlock(v('principles'))}\n\n`;

      // Methodology
      md += `## Standard Approach / Methodology\n\n`;
      md += `${formatBlock(v('methodology'))}\n\n`;

      // Key terms (optional)
      if (v('keyTerms')) {
        md += `## Key Terms & Definitions\n\n`;
        md += `${formatBlock(v('keyTerms'))}\n\n`;
      }

      // Checklist
      md += `## Checklist — Always Verify\n\n`;
      md += `${textToList(v('checklist'))}\n\n`;

      // Procedures (optional)
      if (v('procedures')) {
        md += `## Standard Procedures & Required Filings\n\n`;
        md += `${formatBlock(v('procedures'))}\n\n`;
      }

      // Templates (optional)
      if (v('templates')) {
        md += `## Standard Documents & Templates\n\n`;
        md += `${formatBlock(v('templates'))}\n\n`;
      }

      // Common mistakes
      md += `## Common Mistakes & Oversights\n\n`;
      md += `${formatBlock(v('mistakes'))}\n\n`;

      // Red flags
      md += `## Red Flags & Risk Areas\n\n`;
      md += `${formatBlock(v('redFlags'))}\n\n`;

      // Jurisdictional (optional)
      if (v('jurisdictional')) {
        md += `## Jurisdictional Considerations\n\n`;
        md += `${formatBlock(v('jurisdictional'))}\n\n`;
      }

      // Quality (optional)
      if (v('quality')) {
        md += `## What Separates Excellent Work\n\n`;
        md += `${formatBlock(v('quality'))}\n\n`;
      }

      // Client communication (optional)
      if (v('clientComm')) {
        md += `## Client Communication Priorities\n\n`;
        md += `${formatBlock(v('clientComm'))}\n\n`;
      }

      // Statutes (optional)
      if (v('statutes')) {
        md += `## Key Authorities & Regulations\n\n`;
        md += `${formatBlock(v('statutes'))}\n\n`;
      }

      // Resources (optional)
      if (v('resources')) {
        md += `## Resources & References\n\n`;
        md += `${formatBlock(v('resources'))}\n\n`;
      }

      // Additional (optional)
      if (v('additional')) {
        md += `## Additional Expert Knowledge\n\n`;
        md += `${formatBlock(v('additional'))}\n\n`;
      }

      // Footer
      md += `---\n\n`;
      md += `*Generated via Mavacy SME Knowledge Transfer on ${now}. Review and integrate into the appropriate knowledge folder before use.*\n`;

      // Show preview
      document.getElementById('markdownOutput').textContent = md;
      const panel = document.getElementById('previewPanel');
      panel.classList.add('visible');
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Store for download/copy
      window._generatedMarkdown = md;
      window._fileName = area.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '.md';

      showToast('Markdown generated! Review below.');
    }

    // ─── Download ───────────────────────────────────────────
    function downloadMarkdown() {
      if (!window._generatedMarkdown) return;
      const blob = new Blob([window._generatedMarkdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = window._fileName || 'sme-knowledge.md';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Downloaded ' + (window._fileName || 'sme-knowledge.md'));
    }

    // ─── Copy ───────────────────────────────────────────────
    function copyMarkdown() {
      if (!window._generatedMarkdown) return;
      navigator.clipboard.writeText(window._generatedMarkdown).then(() => {
        showToast('Copied to clipboard!');
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = window._generatedMarkdown;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Copied to clipboard!');
      });
    }

    // ─── Clear form ─────────────────────────────────────────
    function clearForm() {
      if (!confirm('Clear all answers? This cannot be undone.')) return;
      document.getElementById('smeForm').reset();
      document.getElementById('previewPanel').classList.remove('visible');
      window._generatedMarkdown = null;
      updateProgress();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('Form cleared.');
    }

    // ─── Auto-save to localStorage ──────────────────────────
    const STORAGE_KEY = 'mavacy_sme_draft';

    function saveToStorage() {
      const data = {};
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.id) data[el.id] = el.value;
      });
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch(e) { /* storage full or unavailable */ }
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        Object.keys(data).forEach(id => {
          const el = document.getElementById(id);
          if (el && data[id]) {
            el.value = data[id];
          }
        });
        updateProgress();
      } catch(e) { /* corrupt data */ }
    }

    // Auto-save every 5 seconds
    setInterval(saveToStorage, 5000);
    // Also save on input
    document.querySelectorAll('input, select, textarea').forEach(el => {
      el.addEventListener('input', saveToStorage);
      el.addEventListener('change', saveToStorage);
    });

    // Load saved data on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
    });
  </script>

</body>
</html>
